\RequirePackage{authblk,orcidlink}
\RequirePackage{xspace}
\RequirePackage{amsmath,amssymb,amsfonts,amsthm,thmtools,thm-restate,amsopn}
\RequirePackage{hyperref}
\RequirePackage{xcolor}
\RequirePackage{enumitem,marvosym}
\RequirePackage[most]{tcolorbox}
\RequirePackage{tabularx,colortbl,ltablex,booktabs}
\RequirePackage{algpseudocode,algorithm}
\RequirePackage[width=\textwidth,textfont=sl]{caption}
\RequirePackage[capitalize,noabbrev]{cleveref}

\usetikzlibrary{
    backgrounds,
    fit,
    automata,
    positioning,
    shapes.geometric,
    decorations.markings
}

\definecolor{themeColor}{HTML}{BB6588}
\definecolor{themeColor2}{HTML}{8888CC}
\definecolor{themeColor3}{HTML}{CCAA88}


\providecommand*\email[1]{\href{mailto:#1}{\texttt{#1}}}
\renewcommand{\paragraph}[1]{\medskip\noindent\textbf{#1}}
\newcommand{\ignore}[1]{}

\makeatletter
\AddToHook{cmd/appendix/before}{\def\cref@section@alias{appendix}}
\AddToHook{cmd/appendix/before}{\def\cref@subsection@alias{appendix}}
\makeatother


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ensuremath environment
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\mathEnv}[1]{\ensuremath{#1}\xspace}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% math
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\EX}{\mathEnv{\mathbb{E}}}
\newcommand*{\Var}{\mathEnv{\mathbf{Var}}}
\renewcommand*{\Pr}{\mathEnv{\mathbf{Pr}}}
\newcommand*{\med}{\mathEnv{\mathsf{med}}}
\newcommand*{\concat}{\mathEnv{\mathbin\Vert}}
\newcommand*{\defeq}{\mathEnv{\overset{\mathrm{def}}{=}}}

\newcommand*{\true}{\mathEnv{\mathsf{true}}}
\newcommand*{\false}{\mathEnv{\mathsf{false}}}

\newcommand{\stringRev}[1]{\mathEnv{[#1]^{\mathsf{R}}}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% theorem style
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% bold note for plain and definition theoremstyle
\makeatletter
\def\th@plain{\thm@notefont{}\itshape}
\def\th@definition{\thm@notefont{}\normalfont}
\makeatother

\newtheorem{theorem}{Theorem}
\newtheorem*{theorem*}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{definition}{Definition}
\newtheorem*{definition*}{Definition}
\newtheorem{fact}{Fact}
\newtheorem{claim}{Claim}
\newtheorem*{claim*}{Claim}

\theoremstyle{remark}
\newtheorem{remark}{Remark}
\newtheorem{example}{Example}

\Crefname{lemma}{Lemma}{Lemmas}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% complexity class
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\bigO}{\mathEnv{\mathcal{O}}}
\newcommand*{\poly}{\mathEnv{\mathsf{poly}}}
\newcommand*{\polylog}{\mathEnv{\mathsf{polylog}}}
\newcommand*{\negl}{\mathEnv{\mathsf{negl}}}
\newcommand*{\NP}{\mathEnv{\mathsf{NP}}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% party/adv notations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\party}{\mathEnv{\mathsf{P}}}
\newcommand*{\adv}{\mathEnv{\mathcal{A}}}
\newcommand*{\delay}{\mathEnv{\varDelta}}

\newcommand*{\partyset}{\mathEnv{\mathcal{P}}}
\newcommand*{\honestPartySet}{\mathEnv{\mathcal{H}}}
\newcommand*{\newParty}{\mathEnv{\party_{\mathsf{new}}}}

\newcommand*{\E}{\mathEnv{\mathcal{E}}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% blockchain
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\block}{\mathEnv{\mathcal{B}}}
\newcommand*{\chain}{\mathEnv{\mathcal{C}}}
\newcommand*{\chainLocal}{\mathEnv{\chain_{\mathsf{loc}}}}
\newcommand*{\ledger}{\mathEnv{\mathcal{L}}}

\newcommand*{\tx}{\mathEnv{\mathtt{tx}}}

\newcommand{\chainHead}[1]{\mathEnv{\mathrm{head}(#1)}}
\newcommand{\timestamp}[1]{\mathEnv{\mathsf{Timestamp}(#1)}}
\newcommand{\chainPrefix}[2]{\mathEnv{#1^{\lceil{#2}}}}
\newcommand{\chainLength}[1]{\mathEnv{\mathrm{len}(#1)}}
\newcommand{\chainDiff}[1]{\mathEnv{\mathrm{diff}(#1)}}

\newcommand{\blockify}{\mathEnv{\mathsf{Blockify}}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Tables
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\renewcommand{\tabularxcolumn}[1]{m{#1}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% UC Framework
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\sid}{\mathEnv{\mathrm{sid}}}
\newcommand*{\pid}{\mathEnv{\mathrm{pid}}}
\newcommand*{\ok}{\mathEnv{\mathsf{ok}}}
\newcommand*{\Z}{\mathEnv{\mathcal{Z}}}

\newcommand*{\F}{\mathEnv{\mathcal{F}}}
\newcommand*{\func}{\mathEnv{\mathcal{F}}}

\newcommand*{\funcClock}{\mathEnv{\mathcal{G}_{\mathsf{Clock}}}}
\newcommand*{\funcImpClock}{\mathEnv{\mathcal{G}_{\mathsf{ImpClock}}}}
\newcommand*{\funcRO}{\mathEnv{\F_{\mathsf{RO}}}}
\newcommand*{\funcCRS}{\mathEnv{\F_{\mathsf{CRS}}}}
\newcommand*{\funcDiffuse}{\mathEnv{\F_{\mathsf{Diffuse}}}}

\newcommand{\wrapper}[1]{\mathEnv{\mathcal{W}(#1)}}
\newcommand{\funcLedger}{\ensuremath{\mathcal{G}_{\textsf{Ledger}}}\xspace}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Protocol parameters
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\timekeeper}{\mathEnv{\mathsf{Timekeeper}}}
\newcommand*{\syncLen}{\mathEnv{\mathrm{R}}}
\newcommand*{\diffLen}{\mathEnv{\mathrm{M}}}
\newcommand*{\CPLen}{\mathEnv{\mathrm{K}}}
\newcommand*{\maxdrift}{\mathEnv{\varPhi_{\mathrm{clock}}}}
\newcommand*{\maxskew}{\mathEnv{\varPhi}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% State variables
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand*{\localTime}{\mathEnv{\mathtt{localTime}}}
\newcommand*{\interval}{\mathEnv{\mathtt{itvl}}}
\newcommand*{\epoch}{\mathEnv{\mathtt{ep}}}
\newcommand*{\buffer}{\mathEnv{\mathtt{buffer}}}
\newcommand*{\futureChains}{\mathEnv{\mathtt{futureChains}}}
\newcommand*{\syncBuffer}{\mathEnv{\mathtt{syncBuffer}}}
\newcommand*{\isSync}{\mathEnv{\mathtt{isSync}}}
\newcommand{\protocolTime}[2]{\mathEnv{\langle #1, #2 \rangle}}

\newcommand*{\st}{\mathEnv{\mathtt{st}}}
\newcommand*{\round}{\mathEnv{\mathtt{r}}}

\newcommand{\beacon}{\mathEnv{\mathtt{SB}}}
\newcommand{\shift}{\ensuremath{\mathsf{shift}}\xspace}
\newcommand{\Isync}[1]{\ensuremath{I_{\mathsf{sync}}({#1})}\xspace}


\tcbset{
    cccBox/.style={
            enhanced,
            breakable,
            attach boxed title to top left={yshift=-4mm,xshift=5mm},
            coltitle=black,
            boxed title style={colback=white},
            colback=white,
            top=5mm,
            drop fuzzy shadow,
            sharp corners,
            fontupper=\small,
            enlarge top by=2mm,
            enlarge bottom by=3mm,
            segmentation style = {solid, line width = .5mm}
        }
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Protocol Box 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcounter{protoccolCounter}
\setcounter{protoccolCounter}{0}

\newtcolorbox[use counter=protoccolCounter]{protocolbox}[2]{
    cccBox,
    title={\large \textbf{Protocol} #1},
    label=protocol:#2
}

\newcommand{\fboxfootprotocol}{}
\newenvironment{cccProtocol}[3]{
    \renewcommand{\fboxfootprotocol}{#3}
    \begin{protocolbox}{#1}{#2}
        }{
        \tcblower
        Protocol~{\thetcbcounter}: {\sl \fboxfootprotocol}
    \end{protocolbox}
}

\crefname{protoccolCounter}{Protocol}{Protocols}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Functionality Box
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcounter{functionalityCounter}
\setcounter{functionalityCounter}{0}

\newtcolorbox[use counter=functionalityCounter]{functionalitybox}[2]{
    cccBox,
    title={\large \textbf{Functionality} #1},
    label=functionality:#2
}

\newcommand{\fboxfootfunctinoality}{}
\newenvironment{cccFunctionality}[3]{
    \renewcommand{\fboxfootfunctinoality}{#3}
    \begin{functionalitybox}{#1}{#2}
        }{
        \tcblower
        Functionality~{\thetcbcounter}: {\sl \fboxfootfunctinoality}
    \end{functionalitybox}
}

\crefname{functionalityCounter}{Functionality}{Functionalities}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Algorithm Box
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcounter{algorithmCounter}
\setcounter{algorithmCounter}{0}

\newtcolorbox[use counter=algorithmCounter]{algorithmbox}[2]{
    cccBox,
    title={\large \textbf{Algorithm} #1},
    label=algorithm:#2
}

\newcommand{\fboxfootalgorithm}{}
\newenvironment{cccAlgorithm}[3]{
    \renewcommand{\fboxfootalgorithm}{#3}
    \begin{algorithmbox}{#1}{#2}
        }{
        \tcblower
        Algorithm~{\thetcbcounter}: {\sl \fboxfootalgorithm}
    \end{algorithmbox}
}

\crefname{algorithmCounter}{Algorithm}{Algorithms}

\makeatletter
\algnewcommand{\LineComment}[1]{\Statex\hskip\ALG@thistlm{{\color{gray}$\triangleright$ #1}}}
\makeatother
\algrenewcommand{\algorithmiccomment}[1]{\hfill{\color{gray} $\triangleleft$ #1}}
\newcommand{\oneLineIf}[2]{\State{\textbf{if} #1 \textbf{then} #2}}

\makeatletter
\newcommand*\ifcounter[1]{
    \ifcsname c@#1\endcsname
        \expandafter\@firstoftwo
    \else
        \expandafter\@secondoftwo
    \fi
}
\makeatother

\NewDocumentEnvironment{algorithmWithNumbering}{m}{
    \begin{algorithmic}[1]
        \ifcounter{ALG@line@#1}{}{\newcounter{ALG@line@#1}}
        \setcounter{ALG@line}{\value{ALG@line@#1}}
        }{
        \setcounter{ALG@line@#1}{\value{ALG@line}
        }
    \end{algorithmic}%
}

\newenvironment{cccItemize}[1][]{
    \begin{enumerate}[label=\FlatSteel, leftmargin=*, #1]
        }{\end{enumerate}}

\newenvironment{cccEnum}[1][]{
    \begin{enumerate}[label={\arabic*.}, leftmargin=*, #1]
        }{\end{enumerate}}